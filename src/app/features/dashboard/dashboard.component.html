<!-- src/app/features/dashboard/dashboard.component.html -->
<div class="page-header">
  <h1 class="page-title">Dashboard</h1>
  <p class="page-description">Welcome back, {{ currentUser()?.name || 'User' }}! Here's your project overview.</p>
  
  <!-- Analytics Controls -->
  <div class="analytics-controls" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
    <button class="btn btn--secondary btn--small" (click)="refreshAnalytics()" [disabled]="isLoadingAnalytics()">
      {{ isLoadingAnalytics() ? '‚è≥ Loading...' : 'üîÑ Refresh Analytics' }}
    </button>
    
    @if (overdueTasksGroups().length > 0) {
      <button class="btn btn--primary btn--small" (click)="markOverdueTasksUrgent()">
        ‚ö° Mark Overdue Tasks as Urgent ({{ overdueTasksGroups().length }} groups)
      </button>
    }
  </div>
  
  <!-- Analytics Error -->
  @if (analyticsError()) {
    <div class="error-message" style="margin-top: 12px; padding: 12px; background: #fee2e2; border-radius: 6px; color: #991b1b;">
      {{ analyticsError() }}
    </div>
  }
  
  <!-- Debug info for ViewChild/ViewChildren features -->
  <div class="debug-info" style="font-size: 12px; color: #666; margin-top: 8px;">
    <span>Stat Cards: {{ totalStatCards }} | Container Visible: {{ isStatsContainerVisible }} | Highlighted: {{ highlightedCardIndex >= 0 ? highlightedCardIndex : 'None' }}</span>
    <span style="margin-left: 12px;">Avg Completion: {{ averageCompletion().toFixed(2) }}%</span>
  </div>
</div>

<!-- Stats Container with template reference -->
<div #statsContainer class="stats-grid">
  <!-- Stat Cards with template references -->
  <div #statCard class="stat-card" 
       [class.highlighted]="highlightedCardIndex === 0"
       appHighlight="rgba(59, 130, 246, 0.1)" 
       defaultColor="var(--card-bg)"
       (click)="navigateToProjects()"
       (mouseenter)="highlightCard(0)">
    <div class="stat-icon blue">üìÅ</div>
    <div class="stat-content">
      <h3>{{ totalProjects }}</h3>
      <p>Total Projects</p>
      @if (projectStats().length > 0) {
        <small style="font-size: 10px; color: #888;">{{ projectStats().length }} analyzed</small>
      }
    </div>
  </div>
  
  <div #statCard class="stat-card" 
       [class.highlighted]="highlightedCardIndex === 1"
       appHighlight="rgba(249, 115, 22, 0.1)" 
       defaultColor="var(--card-bg)"
       (click)="navigateToTasks('in_progress')"
       (mouseenter)="highlightCard(1)">
    <div class="stat-icon orange">‚ö°</div>
    <div class="stat-content">
      <h3>{{ activeTasks }}</h3>
      <p>Active Tasks</p>
      @if (taskStats().in_progress > 0) {
        <small style="font-size: 10px; color: #888;">{{ taskStats().in_progress }} from DB</small>
      }
    </div>
  </div>
  
  <div #statCard class="stat-card" 
       [class.highlighted]="highlightedCardIndex === 2"
       appHighlight="rgba(34, 197, 94, 0.1)" 
       defaultColor="var(--card-bg)"
       (click)="navigateToTasks('done')"
       (mouseenter)="highlightCard(2)">
    <div class="stat-icon green">‚úì</div>
    <div class="stat-content">
      <h3>{{ completedTasks }}</h3>
      <p>Completed Tasks</p>
      @if (taskStats().done > 0) {
        <small style="font-size: 10px; color: #888;">{{ taskStats().done }} from DB</small>
      }
    </div>
  </div>
  
  <div #statCard class="stat-card" 
       [class.highlighted]="highlightedCardIndex === 3"
       appHighlight="rgba(168, 85, 247, 0.1)" 
       defaultColor="var(--card-bg)"
       (click)="navigateToTasks()"
       (mouseenter)="highlightCard(3)">
    <div class="stat-icon purple">üìã</div>
    <div class="stat-content">
      <h3>{{ totalTasks }}</h3>
      <p>Total Tasks</p>
      @if (dashboardSummary()) {
        <small style="font-size: 10px; color: #888;">{{ dashboardSummary()!.pending_tasks }} pending</small>
      }
    </div>
  </div>
</div>

<!-- ViewChild Demo Controls -->
<div class="demo-controls" style="margin: 16px 0; padding: 12px; background: var(--card-bg); border-radius: 8px;">
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <button class="btn btn--secondary btn--small" (click)="highlightCard(0)">Highlight Projects</button>
    <button class="btn btn--secondary btn--small" (click)="highlightCard(1)">Highlight Active Tasks</button>
    <button class="btn btn--secondary btn--small" (click)="highlightCard(2)">Highlight Completed</button>
    <button class="btn btn--secondary btn--small" (click)="highlightCard(3)">Highlight Total Tasks</button>
    <button class="btn btn--secondary btn--small" (click)="highlightCard(-1)">Clear Highlight</button>
  </div>
</div>

<!-- NEW: Project Statistics Section (JdbcTemplate Analytics) -->
@if (projectStats().length > 0) {
  <div class="card" style="margin-bottom: 24px;">
    <div class="card-body">
      <h2 class="section-title">üìä Project Analytics (via JdbcTemplate)</h2>
      <div class="project-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
        @for (stat of projectStats(); track stat.projectId) {
          <div class="project-stat-card" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <h4 style="margin: 0 0 12px 0; font-size: 16px;">{{ stat.projectName }}</h4>
            <div class="progress-bar" style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
              <div class="progress-fill" 
                   [style.width.%]="stat.completionPercentage"
                   [style.background-color]="stat.completionPercentage === 100 ? '#10b981' : '#3b82f6'"
                   style="height: 100%; transition: width 0.3s;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
              <span>{{ stat.completedTasks }}/{{ stat.totalTasks }} tasks</span>
              <span>{{ stat.completionPercentage.toFixed(1) }}%</span>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- NEW: Upcoming Deadlines (JdbcTemplate Analytics) -->
@if (upcomingDeadlines().length > 0) {
  <div class="card" style="margin-bottom: 24px;">
    <div class="card-body">
      <h2 class="section-title">‚è∞ Upcoming Deadlines (Next 7 Days)</h2>
      <div class="deadline-list" style="display: flex; flex-direction: column; gap: 12px;">
        @for (deadline of upcomingDeadlines(); track deadline.id) {
          <div class="deadline-item" style="background: var(--surface-color); border-left: 3px solid var(--primary-color); padding: 12px; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div>
                <strong>{{ deadline.title }}</strong>
                <p style="margin: 4px 0; font-size: 12px; color: #666;">
                  Project: {{ deadline.project_name }} | Assigned to: {{ deadline.assigned_to_name }}
                </p>
              </div>
              <div style="text-align: right;">
                <span class="badge" [class]="'badge--' + deadline.priority">{{ deadline.priority }}</span>
                <p style="margin: 4px 0; font-size: 12px; color: #666;">Due: {{ deadline.due_date }}</p>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- NEW: Overdue Tasks Alert (JdbcTemplate Analytics) -->
@if (overdueTasksGroups().length > 0) {
  <div class="card" style="margin-bottom: 24px; border-left: 4px solid #ef4444;">
    <div class="card-body">
      <h2 class="section-title" style="color: #ef4444;">‚ö†Ô∏è Overdue Tasks by Priority</h2>
      <div class="overdue-list" style="display: flex; flex-direction: column; gap: 12px;">
        @for (group of overdueTasksGroups(); track group.priority) {
          <div class="overdue-group" style="background: #fee2e2; padding: 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h4 style="margin: 0; text-transform: capitalize;">
                <span class="badge" [class]="'badge--' + group.priority">{{ group.priority }}</span>
              </h4>
              <span style="font-weight: bold; color: #991b1b;">{{ group.overdue_count }} overdue</span>
            </div>
            <p style="margin: 0; font-size: 13px; color: #7f1d1d;">
              Tasks: {{ group.task_titles }}
            </p>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Existing Content -->
<div class="grid" style="grid-template-columns: 1fr;">
  <div class="card">
    <div class="card-body">
      <h2 class="section-title">Recent Activities</h2>
      <div class="activity-list">
        @for (task of recentTasks; track task.id) {
          <div class="activity-item">
            <div class="activity-avatar">{{ getUserAvatar(task.assignedTo[0]) }}</div>
            <div class="activity-content">
              <p class="activity-text">
                <!-- <strong>{task.description}</strong> -->
              </p>
              <p class="activity-time">{{ task.createdAt | timeAgo }}</p>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<div class="grid grid-2 mt-16">
  <div class="card">
    <div class="card-body">
      <h2 class="section-title">Quick Actions</h2>
      <div class="flex flex-col gap-8">
        <button class="btn btn--primary w-full" (click)="openCreateProjectDialog()">+ Create New Project</button>
        <button class="btn btn--secondary w-full" (click)="openCreateTaskDialog()">+ Add New Task</button>
        <button class="btn btn--secondary w-full" (click)="navigate('/team')">View Team Members</button>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-body">
      <h2 class="section-title">Task Summary</h2>
      <div class="flex flex-col gap-12">
        <div>
          <div class="flex justify-between mb-8">
            <span>Todo</span>
            <span class="badge badge--todo">{{ todoTasks }}</span>
          </div>
          <div class="flex justify-between mb-8">
            <span>In Progress</span>
            <span class="badge badge--in_progress">{{ activeTasks }}</span>
          </div>
          <div class="flex justify-between">
            <span>Completed</span>
            <span class="badge badge--done">{{ completedTasks }}</span>
          </div>
        </div>
        
        <!-- ViewChildren Info -->
        <div class="viewchildren-info" style="padding: 12px; background: rgba(0,0,0,0.02); border-radius: 6px;">
          <div style="font-size: 11px; color: #888;">
            <div>Total Cards: {{ totalStatCards }}</div>
            <div>Container Visible: {{ isStatsContainerVisible ? 'Yes' : 'No' }}</div>
            <div>Analytics Loaded: {{ !isLoadingAnalytics() ? 'Yes' : 'No' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Existing Dialogs (Keep as is) -->
<!-- Create Project Dialog -->
@if (showCreateProjectDialog) {
<div class="dialog-overlay">
  <div class="dialog">
    <div class="dialog-header">
      <h2 class="dialog-title">Create New Project</h2>
      <button class="dialog-close" (click)="closeCreateProjectDialog()">√ó</button>
    </div>
    
    <div class="dialog-body">
      <form [formGroup]="projectForm" class="form">
        <div class="form-group">
          <label for="projectName" class="form-label">Project Name</label>
          <input
            type="text"
            id="projectName"
            formControlName="name"
            class="form-input"
            placeholder="Enter project name"
            #projectNameInput
          />
          @if (projectForm.get('name')?.invalid && projectForm.get('name')?.touched) {
            <div class="form-error">
              Project name is required and must be at least 3 characters long.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="projectDescription" class="form-label">Description</label>
          <textarea
            id="projectDescription"
            formControlName="description"
            class="form-textarea"
            placeholder="Enter project description"
            rows="3"
          ></textarea>
          @if (projectForm.get('description')?.invalid && projectForm.get('description')?.touched) {
            <div class="form-error">
              Description is required and must be at least 10 characters long.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="projectStatus" class="form-label">Status</label>
          <select
            id="projectStatus"
            formControlName="status"
            class="form-select"
          >
            <option value="planning">Planning</option>
            <option value="in_progress">In Progress</option>
            <option value="on_hold">On Hold</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div class="form-group">
          <label for="projectStartDate" class="form-label">Start Date</label>
          <input
            type="date"
            id="projectStartDate"
            formControlName="startDate"
            class="form-input"
          />
          @if (projectForm.get('startDate')?.invalid && projectForm.get('startDate')?.touched) {
            <div class="form-error">
              Start date is required.
            </div>
          }
        </div>
      </form>
    </div>
    
    <div class="dialog-footer">
      <button class="btn btn--secondary" (click)="closeCreateProjectDialog()">Cancel</button>
      <button 
        class="btn btn--primary" 
        (click)="createProject()"
        [disabled]="!projectForm.valid"
      >
        Create Project
      </button>
    </div>
  </div>
</div>
}

<!-- Create Task Dialog -->
@if (showCreateTaskDialog) {
<div class="dialog-overlay">
  <div class="dialog">
    <div class="dialog-header">
      <h2 class="dialog-title">Create New Task</h2>
      <button class="dialog-close" (click)="closeCreateTaskDialog()">√ó</button>
    </div>
    
    <div class="dialog-body">
      <form [formGroup]="taskForm" class="form">
        <div class="form-group">
          <label for="taskTitle" class="form-label">Task Title</label>
          <input
            type="text"
            id="taskTitle"
            formControlName="title"
            class="form-input"
            placeholder="Enter task title"
            #taskTitleInput
          />
          @if (taskForm.get('title')?.invalid && taskForm.get('title')?.touched) {
            <div class="form-error">
              Task title is required and must be at least 3 characters long.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="taskDescription" class="form-label">Description</label>
          <textarea
            id="taskDescription"
            formControlName="description"
            class="form-textarea"
            placeholder="Enter task description"
            rows="3"
          ></textarea>
          @if (taskForm.get('description')?.invalid && taskForm.get('description')?.touched) {
            <div class="form-error">
              Description is required and must be at least 10 characters long.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="taskProject" class="form-label">Project</label>
          <select
            id="taskProject"
            formControlName="projectId"
            class="form-select"
          >
            <option value="">Select a project</option>
            @for (project of projects(); track project.id) {
              <option [value]="project.id">{{ project.name }}</option>
            }
          </select>
          @if (taskForm.get('projectId')?.invalid && taskForm.get('projectId')?.touched) {
            <div class="form-error">
              Project is required.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="taskStatus" class="form-label">Status</label>
          <select
            id="taskStatus"
            formControlName="status"
            class="form-select"
          >
            <option value="todo">Todo</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
          </select>
        </div>

        <div class="form-group">
          <label for="taskPriority" class="form-label">Priority</label>
          <select
            id="taskPriority"
            formControlName="priority"
            class="form-select"
          >
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="form-group">
          <label for="taskDueDate" class="form-label">Due Date</label>
          <input
            type="date"
            id="taskDueDate"
            formControlName="dueDate"
            class="form-input"
          />
          @if (taskForm.get('dueDate')?.invalid && taskForm.get('dueDate')?.touched) {
            <div class="form-error">
              Due date is required.
            </div>
          }
        </div>

        <div class="form-group">
          <label for="taskAssignedTo" class="form-label">Assign To</label>
          <select
            id="taskAssignedTo"
            formControlName="assignedTo"
            class="form-select"
          >
            <option value="">Select a team member</option>
            @for (user of users(); track user.id) {
              <option [value]="user.id">{{ user.name }}</option>
            }
          </select>
          @if (taskForm.get('assignedTo')?.invalid && taskForm.get('assignedTo')?.touched) {
            <div class="form-error">
              Assigning to a team member is required.
            </div>
          }
        </div>
      </form>
    </div>
    
    <div class="dialog-footer">
      <button class="btn btn--secondary" (click)="closeCreateTaskDialog()">Cancel</button>
      <button 
        class="btn btn--primary" 
        (click)="createTask()"
        [disabled]="!taskForm.valid"
      >
        Create Task
      </button>
    </div>
  </div>
</div>
}